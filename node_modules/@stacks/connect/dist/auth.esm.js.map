{"version":3,"file":"auth.esm.js","sources":["../src/auth.ts"],"sourcesContent":["import { AppConfig, UserSession } from '@stacks/auth';\nimport { decodeToken } from 'jsontokens';\nimport type { AuthOptions, AuthResponsePayload } from './types';\n\nimport { getStacksProvider } from './utils';\n\nexport const defaultAuthURL = 'https://app.blockstack.org';\n\nconst version = __VERSION__;\n\nif (typeof window !== 'undefined') {\n  window.__CONNECT_VERSION__ = version;\n}\n\nexport const isMobile = () => {\n  const ua = navigator.userAgent;\n  if (/android/i.test(ua)) {\n    return true;\n  }\n  if (/iPad|iPhone|iPod/.test(ua)) {\n    return true;\n  }\n  return /windows phone/i.test(ua);\n};\n\n/**\n * mobile should not use a 'popup' type of window.\n */\nexport const shouldUsePopup = () => {\n  return !isMobile();\n};\n\nexport const getOrCreateUserSession = (userSession?: UserSession): UserSession => {\n  if (!userSession) {\n    const appConfig = new AppConfig(['store_write'], document.location.href);\n    userSession = new UserSession({ appConfig });\n  }\n  return userSession;\n};\n\nexport const authenticate = async (authOptions: AuthOptions) => {\n  const provider = getStacksProvider();\n  if (!provider) {\n    throw new Error('Unable to authenticate without Hiro Wallet extension');\n  }\n\n  const {\n    redirectTo = '/',\n    manifestPath,\n    onFinish,\n    onCancel,\n    sendToSignIn = false,\n    userSession: _userSession,\n    appDetails,\n  } = authOptions;\n  const userSession = getOrCreateUserSession(_userSession);\n  if (userSession.isUserSignedIn()) {\n    userSession.signUserOut();\n  }\n  const transitKey = userSession.generateAndStoreTransitKey();\n  const authRequest = userSession.makeAuthRequest(\n    transitKey,\n    `${document.location.origin}${redirectTo}`,\n    `${document.location.origin}${manifestPath}`,\n    userSession.appConfig.scopes,\n    undefined,\n    undefined,\n    {\n      sendToSignIn,\n      appDetails,\n      connectVersion: version,\n    }\n  );\n\n  try {\n    const authResponse = await provider.authenticationRequest(authRequest);\n    await userSession.handlePendingSignIn(authResponse);\n    const token = decodeToken(authResponse);\n    const payload = token?.payload;\n    const authResponsePayload = payload as unknown as AuthResponsePayload;\n    onFinish?.({\n      authResponse,\n      authResponsePayload,\n      userSession,\n    });\n  } catch (error) {\n    console.error('[Connect] Error during auth request', error);\n    onCancel?.();\n  }\n};\n\nexport const getUserData = async (userSession?: UserSession) => {\n  userSession = getOrCreateUserSession(userSession);\n  if (userSession.isUserSignedIn()) {\n    return userSession.loadUserData();\n  }\n  if (userSession.isSignInPending()) {\n    return userSession.handlePendingSignIn();\n  }\n  return null;\n};\n"],"names":["defaultAuthURL","version","__VERSION__","window","__CONNECT_VERSION__","isMobile","ua","navigator","userAgent","test","shouldUsePopup","getOrCreateUserSession","userSession","appConfig","AppConfig","document","location","href","UserSession","authenticate","authOptions","provider","getStacksProvider","Error","redirectTo","manifestPath","onFinish","onCancel","sendToSignIn","_userSession","appDetails","isUserSignedIn","signUserOut","transitKey","generateAndStoreTransitKey","authRequest","makeAuthRequest","origin","scopes","connectVersion","authenticationRequest","authResponse","handlePendingSignIn","token","decodeToken","payload","authResponsePayload","error","getUserData","loadUserData","isSignInPending"],"mappings":";;;;;;IAMaA,iBAAiB;AAE9B,IAAMC,UAAUC,QAAhB;;AAEA,IAAI,OAAOC,MAAP,KAAkB,WAAtB,EAAmC;SAC1BC,sBAAsBH;;;IAGlBI,WAAW,SAAXA,QAAW,GAAM;MACtBC,KAAKC,UAAUC;;MACjB,WAAWC,IAAX,CAAgBH,EAAhB,GAAqB;WAChB;;;MAEL,mBAAmBG,IAAnB,CAAwBH,EAAxB,GAA6B;WACxB;;;SAEF,iBAAiBG,IAAjB,CAAsBH,EAAtB;;IAMII,iBAAiB,SAAjBA,cAAiB,GAAM;SAC3B,CAACL;;IAGGM,yBAAyB,SAAzBA,sBAAyB,CAACC,WAAD,EAA4C;MAC5E,CAACA,aAAa;QACVC,YAAY,IAAIC,SAAJ,CAAc,CAAC,aAAD,CAAd,EAA+BC,SAASC,QAAT,CAAkBC,IAAjD;kBACJ,IAAIC,WAAJ,CAAgB;AAAEL,MAAAA,WAAAA;AAAF,KAAhB;;;SAETD;;IAGIO;mFAAe,iBAAOC,WAAP;AAAA;;AAAA;AAAA;AAAA;AAAA;AACpBC,YAAAA,QADoB,GACTC,mBADS;;AAAA,gBAErBD,QAFqB;AAAA;AAAA;AAAA;;AAAA,kBAGlB,IAAIE,KAAJ,CAAU,sDAAV,CAHkB;;AAAA;AAAA,oCActBH,WAdsB,CAOxBI,UAPwB,EAOxBA,UAPwB,sCAOX,GAPW,0BAQxBC,YARwB,GActBL,WAdsB,CAQxBK,YARwB,EASxBC,QATwB,GActBN,WAdsB,CASxBM,QATwB,EAUxBC,QAVwB,GActBP,WAdsB,CAUxBO,QAVwB,0BActBP,WAdsB,CAWxBQ,YAXwB,EAWxBA,YAXwB,sCAWT,KAXS,0BAYXC,YAZW,GActBT,WAdsB,CAYxBR,WAZwB,EAaxBkB,UAbwB,GActBV,WAdsB,CAaxBU,UAbwB;AAepBlB,YAAAA,WAfoB,GAeND,uBAAuBkB,aAfjB;;gBAgBtBjB,YAAYmB,cAAZ,IAA8B;0BACpBC;;;AAERC,YAAAA,UAnBoB,GAmBPrB,YAAYsB,0BAAZ,EAnBO;AAoBpBC,YAAAA,WApBoB,GAoBNvB,YAAYwB,eAAZ,CAClBH,UADkB,OAEflB,SAASC,QAAT,CAAkBqB,MAFH,GAEYb,UAFZ,OAGfT,SAASC,QAAT,CAAkBqB,MAHH,GAGYZ,YAHZ,EAIlBb,YAAYC,SAAZ,CAAsByB,MAJJ,EAKlB,MALkB,EAMlB,MANkB,EAOlB;AACEV,cAAAA,cAAAA,YADF;AAEEE,cAAAA,YAAAA,UAFF;AAGES,cAAAA,gBAAgBtC;AAHlB,aAPkB,CApBM;AAAA;AAAA;AAAA,mBAmCGoB,SAASmB,qBAAT,CAA+BL,WAA/B,CAnCH;;AAAA;AAmClBM,YAAAA,YAnCkB;AAAA;AAAA,mBAoClB7B,YAAY8B,mBAAZ,CAAgCD,YAAhC,CApCkB;;AAAA;AAqClBE,YAAAA,KArCkB,GAqCVC,YAAYH,aArCF;AAsClBI,YAAAA,OAtCkB,GAsCRF,KAtCQ,oBAsCRA,MAAOE,OAtCC;AAuClBC,YAAAA,mBAvCkB,GAuCID,OAvCJ;iDAwCb;AACTJ,cAAAA,cAAAA,YADS;AAETK,cAAAA,qBAAAA,mBAFS;AAGTlC,cAAAA,aAAAA;AAHS;AAxCa;AAAA;;AAAA;AAAA;AAAA;oBA8ChBmC,MAAM;;;AA9CU;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;kBAAf5B;;;;IAmDA6B;oFAAc,kBAAOpC,WAAP;AAAA;AAAA;AAAA;AAAA;0BACXD,uBAAuBC;;AADZ,iBAErBA,YAAYmB,cAAZ,EAFqB;AAAA;AAAA;AAAA;;AAAA,8CAGhBnB,YAAYqC,YAAZ,EAHgB;;AAAA;AAAA,iBAKrBrC,YAAYsC,eAAZ,EALqB;AAAA;AAAA;AAAA;;AAAA,8CAMhBtC,YAAY8B,mBAAZ,EANgB;;AAAA;AAAA,8CAQlB,IARkB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;kBAAdM;;;;;;;"}